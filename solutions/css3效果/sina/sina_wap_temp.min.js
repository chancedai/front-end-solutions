var card = {
  _events: {},
  _windowHeight: function() {
    return $(window).height()
  },
  _windowWidth: function() {
    return $(window).width()
  },
  _elementStyle: document.createElement("div").style,
  _page: $(".page"),
  _pageNum: $(".page").size(),
  _loading: $("#j_loading"),
  _percent: $("#j_percent"),
  _preLoadNum: preLoadNum,
  _touchEndCallback: "",
  _preLoadPics: [],
  _pageNow: 0,
  _pageNext: null,
  _touchStartValY: 0,
  _touchDeltaY: 0,
  _moveStart: true,
  _movePosition: null,
  _movePosition_c: null,
  _mouseDown: false,
  _moveFirst: true,
  _moveInit: false,
  _firstChange: false,
  _vendor: function() {
    var A = ["t", "webkitT", "MozT", "msT", "OT"], B,
      C = 0,
      D = A.length;
    for (; C < D; C++) {
      B = A[C] + "ransform";
      if (B in this._elementStyle) {
        return A[C].substr(0, A[C].length - 1)
      }
    }
    return false
  },
  _prefixStyle: function(A) {
    if (this._vendor() === false) {
      return false
    }
    if (this._vendor() === "") {
      return A
    }
    return this._vendor() + A.charAt(0).toUpperCase() + A.substr(1)
  },
  _hasPerspective: function() {
    var A = this._prefixStyle("perspective") in this._elementStyle;
    if (A && "webkitPerspective" in this._elementStyle) {
      this._injectStyles("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}", function(B, C) {
        A = B.offsetLeft === 9 && B.offsetHeight === 3
      })
    }
    return !!A
  },
  _translateZ: function() {
    if (card._hasPerspective) {
      return " translateZ(0)"
    } else {
      return ""
    }
  },
  _injectStyles: function(B, F, H, C) {
    var G, D, A, J,
      I = document.createElement("div"),
      K = document.body,
      L = K || document.createElement("body"),
      E = "modernizr";
    if (parseInt(H, 10)) {
      while (H--) {
        A = document.createElement("div");
        A.id = C ? C[H] : E + (H + 1);I.appendChild(A)
      }
    }
    G = ["&#173;", '<style id="s', E, '">', B, "</style>"].join("");
    I.id = E;
    (K ? I : L).innerHTML += G;L.appendChild(I);
    if (!K) {
      L.style.background = "";
      L.style.overflow = "hidden";
      J = docElement.style.overflow;
      docElement.style.overflow = "hidden";docElement.appendChild(L)
    }
    D = F(I, B);
    if (!K) {
      L.parentNode.removeChild(L);
      docElement.style.overflow = J
    } else {
      I.parentNode.removeChild(I)
    }
    return !!D
  },
  _handleEvent: function(B) {
    if (!this._events[B]) {
      return
    }
    var A = 0,
      C = this._events[B].length;
    if (!C) {
      return
    }
    for (; A < C; A++) {
      this._events[B][A].apply(this, [].slice.call(arguments, 1))
    }
  },
  _on: function(A, B) {
    if (!this._events[A]) {
      this._events[A] = []
    }
    this._events[A].push(B)
  },
  _scrollStop: function() {
    $(window).on("touchmove.scroll", this._scrollControl);$(window).on("scroll.scroll", this._scrollControl)
  },
  _scrollStart: function() {
    $(window).off("touchmove.scroll");$(window).off("scroll.scroll")
  },
  _scrollControl: function(A) {
    A.preventDefault()
  },
  page_start: function() {
    card._page.on("touchstart mousedown", card.page_touch_start);card._page.on("touchmove mousemove", card.page_touch_move);card._page.on("touchend mouseup", card.page_touch_end)
  },
  page_stop: function() {
    card._page.off("touchstart mousedown");card._page.off("touchmove mousemove");card._page.off("touchend mouseup")
  },
  page_touch_start: function(A) {
    if (!card._moveStart) {
      return
    }
    if (!window.webLimit || !webLimit) {
      return false
    }
    if (A.type == "touchstart") {
      card._touchStartValY = window.event.touches[0].pageY
    } else {
      card._touchStartValY = A.pageY || A.y;
      card._mouseDown = true
    }
    card._moveInit = true;card._handleEvent("start")
  },
  page_touch_move: function(C) {
    C.preventDefault();
    if (!card._moveStart) {
      return
    }
    if (!card._moveInit) {
      return
    }
    if (!window.webLimit || !webLimit) {
      return false
    }
    var A = card._page.eq(card._pageNow), D,
      B = null;
    if (C.type == "touchmove") {
      D = window.event.touches[0].pageY
    } else {
      if (card._mouseDown) {
        D = C.pageY || C.y
      } else {
        return
      }
    }
    B = card.page_position(C, D, A);card.page_translate(B);card._handleEvent("move")
  },
  page_position: function(F, C, A) {
    var E, D;
    if (C != "undefined") {
      card._touchDeltaY = C - card._touchStartValY
    }
    card._movePosition = card._touchDeltaY > 0 ? "down" : "up";
    if (card._movePosition != card._movePosition_c) {
      card._moveFirst = true;
      card._movePosition_c = card._movePosition
    } else {
      card._moveFirst = false
    }
    if (card._touchDeltaY <= 0) {
      if (A.next(".page").length == 0) {
        card._pageNext = 0
      } else {
        card._pageNext = card._pageNow + 1
      }
      D = card._page.eq(card._pageNext)[0]
    } else {
      if (A.prev(".page").length == 0) {
        if (card._firstChange) {
          card._pageNext = card._pageNum - 1
        } else {
          return
        }
      } else {
        card._pageNext = card._pageNow - 1
      }
      D = card._page.eq(card._pageNext)[0]
    }
    E = card._page.eq(card._pageNow)[0];
    node = [D, E];
    if (card._moveFirst) {
      B(node)
    }
    function B(H) {
      card._page.removeClass("action");$(H[1]).addClass("action").removeClass("hide");card._page.not(".action").addClass("hide");card.height_auto(card._page.eq(card._pageNext));$(H[0]).removeClass("hide").addClass("active");var I = Math.max($(window).height(), $(H[0]).height()),
        G = card._translateZ();
      if (card._movePosition == "up") {
        H[0].style[card._prefixStyle("transform")] = "translate(0," + I + "px)" + G;$(H[0]).attr("data-translate", I);$(H[1]).attr("data-translate", 0)
      } else {
        H[0].style[card._prefixStyle("transform")] = "translate(0,-" + I + "px)" + G;$(H[0]).attr("data-translate", -I);$(H[1]).attr("data-translate", 0)
      }
    }
    return node
  },
  page_translate: function(A) {
    if (!A) {
      return
    }
    var C = card._translateZ(),
      F = card._touchDeltaY, D, E, B;
    if ($(A[0]).attr("data-translate")) {
      D = F + parseInt($(A[0]).attr("data-translate"))
    }
    A[0].style[card._prefixStyle("transform")] = "translate(0," + D + "px)" + C;
    if ($(A[1]).attr("data-translate")) {
      E = F + parseInt($(A[1]).attr("data-translate"))
    }
    B = 1 - Math.abs(F * 0.2 / $(window).height());
    E = E * 0.2;
    A[1].style[card._prefixStyle("transform")] = "translate(0," + E + "px)" + C + " scale(" + B + ")"
  },
  page_touch_end: function(A) {
    card._moveInit = false;
    card._mouseDown = false;
    if (!card._moveStart) {
      return
    }
    if (!card._pageNext && card._pageNext != 0) {
      return
    }
    card._moveStart = false;
    if (Math.abs(card._touchDeltaY) > 10) {
      card._page.eq(card._pageNext)[0].style[card._prefixStyle("transition")] = "all .3s";
      card._page.eq(card._pageNow)[0].style[card._prefixStyle("transition")] = "all .3s"
    }
    if (Math.abs(card._touchDeltaY) >= 100) {
      card.page_success()
    } else {
      card.page_fial()
    }
    card._handleEvent("end");
    card._movePosition = null;
    card._movePosition_c = null;
    card._touchStartValY = 0
  },
  page_success: function() {
    var C = card._translateZ();
    card._page.eq(card._pageNext)[0].style[card._prefixStyle("transform")] = "translate(0,0)" + C;
    var B = card._touchDeltaY > 0 ? $(window).height() * 0.2 : -$(window).height() * 0.2;
    var A = 1 - 0.2;
    card._page.eq(card._pageNow)[0].style[card._prefixStyle("transform")] = "translate(0," + B + "px)" + C + " scale(" + A + ")";
    if (card._pageNext == card._page.length - 1) {
      if ($(".back_tips").length > 0) {
        if (window.history.length > 1) {
          $(".back_tips").show()
        }
      }
    } else {
      if ($(".back_tips").length > 0) {
        $(".back_tips").hide()
      }
    }
    card._handleEvent("success")
  },
  page_fial: function() {
    var A = card._translateZ();
    if (!card._pageNext && card._pageNext != 0) {
      card._moveStart = true;
      card._moveFirst = true;return
    }
    if (card._movePosition == "up") {
      card._page.eq(card._pageNext)[0].style[card._prefixStyle("transform")] = "translate(0," + $(window).height() + "px)" + A
    } else {
      card._page.eq(card._pageNext)[0].style[card._prefixStyle("transform")] = "translate(0,-" + $(window).height() + "px)" + A
    }
    card._page.eq(card._pageNow)[0].style[card._prefixStyle("transform")] = "translate(0,0)" + A + " scale(1)";card._handleEvent("fial")
  },
  haddle_envent_fn: function() {
    card._on("start", card.lazy_third_pic);card._on("move", function() {});card._on("end", function() {});card._on("fial", function() {
      setTimeout(function() {
        card._page.eq(card._pageNow).attr("data-translate", "");
        card._page.eq(card._pageNow)[0].style[card._prefixStyle("transform")] = "";
        card._page.eq(card._pageNow)[0].style[card._prefixStyle("transition")] = "";
        card._page.eq(card._pageNext)[0].style[card._prefixStyle("transform")] = "";
        card._page.eq(card._pageNext)[0].style[card._prefixStyle("transition")] = "";card._page.eq(card._pageNext).removeClass("active").addClass("hide");
        card._moveStart = true;
        card._moveFirst = true;
        card._pageNext = null;
        card._touchDeltaY = 0;card._page.eq(card._pageNow).attr("style", "")
      }, 300)
    });card._on("success", function() {
      if (card._pageNext == 0 && card._pageNow == card._pageNum - 1) {
        card._firstChange = true
      }
      setTimeout(function() {
        if (card._pageNext == card._pageNum - 1) {
          $(".u-arrow").addClass("hide")
        } else {
          $(".u-arrow").removeClass("hide")
        }
        card._page.eq(card._pageNow).addClass("hide");card._page.eq(card._pageNow).attr("data-translate", "");
        card._page.eq(card._pageNow)[0].style[card._prefixStyle("transform")] = "";
        card._page.eq(card._pageNow)[0].style[card._prefixStyle("transition")] = "";
        card._page.eq(card._pageNext)[0].style[card._prefixStyle("transform")] = "";
        card._page.eq(card._pageNext)[0].style[card._prefixStyle("transition")] = "";card._page.eq(card._pageNext).removeClass("active");
        card._pageLast = card._pageNow;
        card._pageNow = card._pageNext;
        card._moveStart = true;
        card._moveFirst = true;
        card._pageNext = null;card._page.eq(card._pageNow).attr("style", "");card._page.eq(card._pageNow).attr("data-translate", "");
        card._touchDeltaY = 0;card._touchEndCallback && card._touchEndCallback(card._pageNow, card._pageLast);setTimeout(function() {
          var F = card._page.eq(card._pageNow).find(".j_moniter");
          if (F.length > 0) {
            F.each(function() {
              if ($(this).data("src")) {
                var G = new Image();
                G.src = $(this).data("src")
              }
            })
          }
          if (window.SUDA) {
            SUDA.log && SUDA.log("", "", "page:" + card._pageNow)
          }
        }, 20)
      }, 300);
      if (card._pageNow + card._preLoadNum <= card._page.length) {
        var E = card._page.eq(card._pageNow + card._preLoadNum),
          C = E.find(".j_preLoad"),
          B = C.length;
        for (var A = 0; A < B; A++) {
          if (C.eq(A).data("bg")) {
            var D = new Image();
            D.src = C.eq(A).data("bg")
          }
          C.eq(A).removeClass("j_preLoad")
        }
      }
    })
  },
  lazy_start: function() {
    setTimeout(function() {
      for (var B = 0; B < 3; B++) {
        var A = $(".m-page").eq(B);
        if (A.length == 0) {
          break
        }
        if (A.find(".lazy-img").length != 0) {
          card.lazy_images(A)
        } else {
          continue
        }
      }
    }, 200)
  },
  lazy_third_pic: function() {
    var B = 3;
    var A = $(".m-page").eq(card._pageNow + B);
    if (A.length == 0) {
      return false
    }
    if (A.find(".lazy-img").length != 0) {
      card.lazy_images(A)
    }
  },
  lazy_images: function(A, B) {
    var C = A.find(".lazy-img");
    C.each(function() {
      var F = $(this),
        D = F.attr("data-src"),
        E = F.attr("data-position"),
        G = F.attr("data-size");
      $("<img />").on("load", function() {
        if (F.is("img")) {
          F.attr("src", D)
        } else {
          F.css({
            "background-image": "url(" + D + ")",
            "background-position": E,
            "background-size": G
          })
        }
      }).attr("src", D);F.removeClass("lazy-img").addClass("lazy-finish")
    })
  },
  height_auto: function(A) {
    A.css({
      height: card._windowHeight(),
      width: card._windowWidth()
    })
  },
  styleInit: function() {
    document.body.style.userSelect = "none";
    document.body.style.mozUserSelect = "none";
    document.body.style.webkitUserSelect = "none";$(".j_next").on("touchmove", function(A) {
      A.preventDefault()
    })
  },
  preLoad: function() {
    var C = Math.min(card._preLoadNum, card._pageNum),
      E = 0,
      D = 0;
    for (var H = 0; H < C; H++) {
      var G = card._page.eq(H).find(".j_preLoad"),
        F = G.length;
      card._preLoadPics[H] = [];
      for (var B = 0; B < F; B++) {
        if (G.eq(B).data("bg")) {
          card._preLoadPics[H].push(G.eq(B).data("bg"));E++
        }
        G.eq(B).removeClass("j_preLoad")
      }
    }
    for (var H = 0; H < C; H++) {
      for (var B = 0; B < card._preLoadPics[H].length; B++) {
        var A = new Image();
        A.src = card._preLoadPics[H][B];
        A.onload = function() {
          D++;
          if (D == E) {
            card._percent.html(100);card._page.eq(0).removeClass("hide");card._loading.children().addClass("open");setTimeout(function() {
              card._loading.addClass("hide");setTimeout(function() {
                card.styleInit();card.haddle_envent_fn();card.page_start();card.lazy_start()
              }, 200)
            }, 1000)
          } else {
            card._percent.html(Math.floor(D / E * 100))
          }
        }
      }
    }
  },
  init: function() {
    card._touchEndCallback = function(B, A) {
      card._page.eq(A).find("video").forEach(function(C) {
        C.pause()
      })
    };card.preLoad()
  }
};
$(function() {
  var G = {
    init: function(O) {
      var N = this;
      N.platform = N._UA();
      if (!N.platform) {
        return
      }
      if (N.platform == "ios") {
        N.installUrl = O.iosInstallUrl;
        N.nativeUrl = O.iosNativeUrl;
        N.openTime = O.iosOpenTime || 800
      } else {
        N.installUrl = O.androidInstallUrl;
        N.nativeUrl = O.androidNativeUrl;
        N.openTime = O.androidOpenTime || 3000
      }
      if (N.platform != "ios" && !!navigator.userAgent.match(/Chrome/i)) {
        N._hackChrome()
      } else {
        N._gotoNative()
      }
    },
    _hackChrome: function() {
      var O = this;
      var Q = Date.now();
      var N = O.nativeUrl.split("://"),
        P = N[0],
        S = N[1];
      var R = new Image();
      R.src = O.schemejc;O._gotoDownload(Q)
    },
    _gotoNative: function() {
      var O = this;
      var Q = Date.now(),
        R = document,
        P = R.body,
        N = R.createElement("iframe");
      N.id = "J_redirectNativeFrame";
      N.style.display = "none";
      N.src = O.nativeUrl;
      if (!P) {
        setTimeout(function() {
          R.body.appendChild(N)
        }, 0)
      } else {
        P.appendChild(N)
      }
      setTimeout(function() {
        R.body.removeChild(N);O._gotoDownload(Q)
      }, O.openTime)
    },
    _gotoDownload: function(O) {
      var N = this;
      var P = Date.now();
      if (P - O < N.openTime + 500) {
        window.location = N.installUrl
      }
    },
    _UA: function() {
      var O = navigator.userAgent;
      var N = O.match(/Android/i);
      if (O.match(/iphone|ipod/ig)) {
        return "ios"
      } else {
        if (O.match(/Android/i)) {
          return "android"
        } else {
          return ""
        }
      }
    }
  };
  function K() {
    var N = navigator.userAgent.toLowerCase();
    if (N.match(/MicroMessenger/i) == "micromessenger") {
      return true
    } else {
      return false
    }
  }
  function C() {
    if (K()) {
      window.location.href = "http://a.app.qq.com/o/simple.jsp?pkgname=com.sina.news"
    }
    var N = {
      iosInstallUrl: "http://sina.cn/j/d.php?k=82",
      androidInstallUrl: "http://sina.cn/j/d.php?k=82",
      iosNativeUrl: "sinanews://news.sina.cn",
      androidNativeUrl: "sinanews://news.sina.cn"
    };G.init(N)
  }
  $(".load_app_tips").on("click", function() {
    C()
  });
  function B() {
    if ($(".j_audio").length == 0) {
      return
    }
    var Q = $(".j_audio"),
      N = Q.data("audiourl"),
      R = Q.find(".j_open"),
      S = Q.find(".j_close"),
      P = document.createElement("audio");
    P.src = N;P.addEventListener("ended", function() {
      P.play()
    }, false);var O = navigator.userAgent.toLowerCase();
    if (/ipad|iphone|mac/i.test(O) && O.indexOf("micromessenger") == -1) {
      S.show();R.hide();
      P.isplay = false
    } else {
      P.play();R.show();S.hide();
      P.isplay = true
    }
    R.on("click", function() {
      P.pause();R.hide();S.show();
      P.isplay = false
    });S.on("click", function() {
      P.play();R.show();S.hide();
      P.isplay = true
    })
  }
  function M() {
    setTimeout(function() {
      var N = card._windowHeight(),
        O = card._windowWidth();
      if (O > N) {
        alert("请竖屏查看页面，效果更佳！")
      } else {
      }
    }, 1200)
  }
  webLimit = (function() {
    var N = location.host,
      Q = "ina.",
      O = "cn",
      P = Q + O;
    if (N.indexOf(P) != -1) {
      return true
    } else {
      return true
    }
  })();
  var J = null,
    I = "onorientationchange" in window ? "orientationchange" : "resize";
  window.addEventListener(I, function() {
    if (J) {
      clearTimeout(J);
      J = null
    }
    J = setTimeout(function() {
      window.scrollTo(0, 0);M()
    }, 600)
  }, false);
  function A() {
    function N() {
      var O = navigator.userAgent.toLowerCase();
      if (O.match(/MicroMessenger/i) == "micromessenger") {
        return true
      } else {
        return false
      }
    }
    if (!N()) {
      $(".j_share_wx").hide()
    }
    $(".j_share_wx").click(function(O) {
      $(".j_share_bg").show();O.preventDefault()
    });$(".j_share_bg").click(function() {
      $(this).hide()
    });
    if (!globalConfig.isLogin) {
      if (window["SINA_OUTLOGIN_LAYER"]) {
        loginLayer = window["SINA_OUTLOGIN_LAYER"];loginLayer.set("sso", {
          entry: "wapsso"
        }).init();
        if ($(".j_share_wb").length > 0) {
          $(".j_share_wb").on("click", function(O) {
            loginLayer.show();O.preventDefault()
          })
        }
        loginLayer.register("login_success", function() {
          var O = $(".j_share_wb").data("href");
          if ($("#j_geiInput").length > 0) {
            tt = $("#j_geiInput").attr("value");
            O += "&title=" + tt
          }
          if ($("#j_huaTextarea").length > 0) {
            cc = "&content=" + $("#j_huaTextarea").attr("value");
            O += cc
          }
          window.location.href = O
        });loginLayer.register("layer_hide", function() {})
      }
    } else {
      $(".j_share_wb").on("click", function(P) {
        var O = $(".j_share_wb").data("href");
        if ($("#j_geiInput").length > 0) {
          tt = $("#j_geiInput").attr("value");
          O += "&title=" + tt
        }
        if ($("#j_huaTextarea").length > 0) {
          cc = "&content=" + $("#j_huaTextarea").attr("value");
          O += cc
        }
        window.location.href = O
      })
    }
  }
  document.addEventListener("WeixinJSBridgeReady", function D() {
    window.shareData = {
      "Link": shareConfig.homeLink,
      "Img_url": shareConfig.logo,
      "Title": shareConfig.title,
      "Content": shareConfig.content,
    };
    if ($("#j_geiInput").length > 0) {
      window.tt = $("#j_geiInput").attr("value")
    }
    if ($("#j_huaTextarea").length > 0) {
      window.cc = $("#j_huaTextarea").attr("value")
    }
    WeixinJSBridge.on("menu:share:timeline", function(N) {
      WeixinJSBridge.invoke("shareTimeline", {
        "img_url": window.shareData.Img_url,
        "img_width": "200",
        "img_height": "200",
        "link": window.shareData.Link,
        "desc": window.cc || window.shareData.Content,
        "title": window.shareData.Title
      }, function(O) {
        _report("timeline", O.err_msg)
      })
    });WeixinJSBridge.on("menu:share:appmessage", function(N) {
      WeixinJSBridge.invoke("sendAppMessage", {
        "img_url": window.shareData.Img_url,
        "img_width": "200",
        "img_height": "200",
        "link": window.shareData.Link,
        "desc": window.cc || window.shareData.Content,
        "title": "给" + window.tt || window.shareData.Title
      }, function(O) {
        _report("send_msg", O.err_msg)
      })
    })
  }, false);setTimeout(function() {
    window.scrollTo(0, 1);card.init();A();B();E();L()
  }, 500);
  function F(N) {
    if (undefined == N || "" == N) {
      return ""
    }
    return H(document.cookie, N, ";", "")
  }
  function H(R, S, N, O) {
    if (R == "") {
      return ""
    }
    O = (O == "") ? "=" : O;
    S += O;var P = R.indexOf(S);
    if (P < 0) {
      return ""
    }
    P += S.length;var Q = R.indexOf(N, P);
    if (Q < P) {
      Q = R.length
    }
    return R.substring(P, Q)
  }
  function L() {
    if ($("#j_geiInput").length > 0) {
      $("#j_geiInput").on("input", function() {
        window.tt = $(this).attr("value")
      })
    }
    if ($("#j_huaTextarea").length > 0) {
      $("#j_huaTextarea").on("input", function() {
        window.cc = $(this).attr("value")
      })
    }
  }
  function E() {
    var N = $(".back_tips");
    if (N.length > 0) {
      if (window.history.length <= 1) {
        N.css("display", "none")
      }
      N.click(function() {
        window.history.length <= 1 ? window.location.href = "http://sina.cn" : window.history.go(-1)
      })
    }
  }
});